export default class Zoomy{el;boxEl;enabled=true;mouseIsDown=false;isDragging=false;lastMouseX=0;lastMouseY=0;options={zoomUpperConstraint:null};originalZIndexValue;originalTransformValue;constructor(elementId,options){this.el=document.getElementById(elementId);this.options={...options};this.boxEl=this.el.parentElement;this.boxEl.style.overflow="hidden";this.options.zoomUpperConstraint||=4;var fn=this.handleMouseEvents.bind(this);this.originalZIndexValue=window.getComputedStyle(this.el).zIndex;this.originalTransformValue=window.getComputedStyle(this.el).transform;this.boxEl.addEventListener("wheel",e=>{this.el.style.zIndex="999999";fn(e)},{passive:false});this.el.addEventListener("mousedown",fn,{passive:false});this.el.addEventListener("mouseout",()=>{if(!this.isDragging){this.el.style.transform="matrix(1, 0, 0, 1, 0, 0)";this.el.style.transform=this.originalTransformValue;this.el.style.zIndex=this.originalZIndexValue}});["mousemove","mouseup","mouseout"].forEach(event=>{document.addEventListener(event,fn,{passive:false})})}transformByMouseEvent(e){var currentMouseX=e.x,currentMouseY=e.y,moveXBy=0,moveYBy=0,img=this.el.getBoundingClientRect(),box=this.boxEl.getBoundingClientRect(),widthFits=img.width<box.width,heightFits=img.height<box.height,currentLeft=img.left,currentRight=img.right,currentTop=img.top,currentBottom=img.bottom;this.isDragging=false;if(e.type==="mousedown"){this.mouseIsDown=true}if(e.type==="mouseup"){this.mouseIsDown=false}if(this.mouseIsDown&&e.type==="mousemove"){this.isDragging=true}if(this.isDragging){var newLeft=currentLeft+(currentMouseX-this.lastMouseX),newRight=currentRight+(currentMouseX-this.lastMouseX),newTop=currentTop+(currentMouseY-this.lastMouseY),newBottom=currentBottom+(currentMouseY-this.lastMouseY),heightInsideCanvas=img.top>=box.top&&img.bottom<=box.bottom,widthInsideCanvas=img.left>=box.left&&img.right<=box.right;var freeX=(img.width>box.width||!widthInsideCanvas)&&!(newLeft<box.left&&(newLeft<=currentLeft&&newRight<=box.right)||newRight>box.right&&(newRight>=currentRight&&newLeft>=box.left));var freeY=(img.height>box.height||!heightInsideCanvas)&&!(newTop<box.top&&(newTop<=currentTop&&newBottom<=box.bottom)||newBottom>box.bottom&&(newBottom>=currentBottom&&newTop>=box.top));if(freeX){moveXBy=currentMouseX-this.lastMouseX}if(freeY){moveYBy=currentMouseY-this.lastMouseY}}if(e.deltaY){var imgCenterX=img.left+img.width/2,imgCenterY=img.top+img.height/2,boxCenterX=box.left+box.width/2,boxCenterY=box.top+box.height/2,newImageCenterXDiff=currentMouseX-imgCenterX,newImageCenterYDiff=currentMouseY-imgCenterY,zoomInImage=this.boxEl.contains(e.target),isShrinking=e.deltaY>0,enlargeOrShrinkBy=0,zoomFactor=.1,currentScale=Math.round(img.width/this.el.offsetWidth*10)/10,fitsEntirely=widthFits&&heightFits,sideFits=widthFits||heightFits;enlargeOrShrinkBy=Math.round((e.deltaY>0?-zoomFactor:zoomFactor)*currentScale*10)/10;var newScale=currentScale+enlargeOrShrinkBy,newWidth=this.el.offsetWidth*newScale,newHeight=this.el.offsetHeight*newScale;if(newScale>this.options.zoomUpperConstraint){enlargeOrShrinkBy=0}else if(currentScale<1.2&&isShrinking){enlargeOrShrinkBy=0;this.el.style.transform="matrix(1, 0, 0, 1, 0, 0)";this.el.style.transform=this.originalTransformValue}else{if(zoomInImage){if(!fitsEntirely){var adjustedDiffX=newImageCenterXDiff/currentScale,adjustedDiffY=newImageCenterYDiff/currentScale;moveXBy=-adjustedDiffX*enlargeOrShrinkBy,moveYBy=-adjustedDiffY*enlargeOrShrinkBy}if(isShrinking){if(sideFits){diffX=imgCenterX-boxCenterX,diffY=imgCenterY-boxCenterY,scaleDiff=1-currentScale;adjustedDiffX=diffX/scaleDiff,adjustedDiffY=diffY/scaleDiff,moveXBy=-adjustedDiffX*enlargeOrShrinkBy,moveYBy=-adjustedDiffY*enlargeOrShrinkBy}var widthShrankBy=newWidth-img.width,oneSideWidthShrankBy=widthShrankBy/2,heightShrankBy=newHeight-img.height,oneSideHeightShrankBy=heightShrankBy/2,horizontalMove=moveXBy-oneSideWidthShrankBy,verticalMove=moveYBy-oneSideHeightShrankBy,boxPadding=0;newLeft=currentLeft+horizontalMove;newRight=newLeft+newWidth;newTop=currentTop+verticalMove;newBottom=newTop+newHeight;if(!widthFits){if(newLeft>currentLeft){var newLeftDistance=box.left-newLeft,movesRightTooMuch=newLeftDistance<-boxPadding,paddedBoxLeft=box.left+boxPadding,leftSideIsVisible=currentLeft>paddedBoxLeft+1;if(movesRightTooMuch&&!leftSideIsVisible){moveXBy+=newLeftDistance+boxPadding}}if(newRight<currentRight){var newRightDistance=box.right-newRight,movesLeftTooMuch=newRightDistance>boxPadding,paddedBoxRight=box.right-boxPadding,rightSideIsVisible=currentRight<paddedBoxRight-1;if(movesLeftTooMuch&&!rightSideIsVisible){moveXBy+=newRightDistance-boxPadding}}}if(!heightFits){if(newTop>currentTop){var newTopDistance=box.top-newTop,movesDownTooMuch=newTopDistance<-boxPadding,paddedBoxTop=box.top+boxPadding,topIsVisible=currentTop>paddedBoxTop+1;if(movesDownTooMuch&&!topIsVisible){moveYBy+=newTopDistance+boxPadding}}if(newBottom<currentBottom){var newBottomDistance=box.bottom-newBottom,movesUpTooMuch=newBottomDistance>boxPadding,paddedBoxBottom=box.bottom-boxPadding,bottomIsVisible=currentBottom<paddedBoxBottom-1;if(movesUpTooMuch&&!bottomIsVisible){moveYBy+=newBottomDistance-boxPadding}}}}}else{var diffX=imgCenterX-boxCenterX,diffY=imgCenterY-boxCenterY,scaleDiff=1-currentScale;adjustedDiffX=diffX/scaleDiff,adjustedDiffY=diffY/scaleDiff,moveXBy=-adjustedDiffX*enlargeOrShrinkBy,moveYBy=-adjustedDiffY*enlargeOrShrinkBy}}}this.transform(this.el,moveXBy,moveYBy,enlargeOrShrinkBy);e.preventDefault();this.lastMouseX=currentMouseX;this.lastMouseY=currentMouseY}getMatrix(){var matrix=this.el.style.transform?.substring(7);if(matrix){matrix=matrix.slice(0,matrix.length-1).split(",").map(parseFloat)}else{matrix=[1,0,0,1,0,0]}return{scaleX:matrix[0],skewY:matrix[1],skewX:matrix[2],scaleY:matrix[3],translateX:matrix[4],translateY:matrix[5]}}transform(el,moveXBy=0,moveYBy=0,enlargeOrShrinkBy=0){var m=this.getMatrix();m.translateX+=moveXBy;m.translateY+=moveYBy;m.scaleX+=enlargeOrShrinkBy;m.scaleY+=enlargeOrShrinkBy;this.el.style.transform="matrix("+Object.values(m).join(", ")+")"}detach(){if(this.boxEl){this.boxEl.removeEventListener("wheel",this.handleMouseEvents)}else{this.el.removeEventListener("wheel",this.handleMouseEvents);this.el.removeEventListener("mouseout",this.handleMouseEvents)}this.el.removeEventListener("mousedown",this.handleMouseEvents);this.el.removeEventListener("mouseover",this.handleMouseEvents);["mousemove","mouseup","mouseout"].forEach(event=>document.removeEventListener(event,this.handleMouseEvents))}enable(){this.enabled=true}disable(){this.enabled=false}handleMouseEvents(e){if(!this.enabled){return false}this.transformByMouseEvent(e)}}